<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebP2P Drop</title>
    <style>
        /* --- ãƒ‡ã‚¶ã‚¤ãƒ³è¨­å®š (iOSé¢¨ã®ã‚¹ã‚¿ã‚¤ãƒ«) --- */
        :root {
            --primary: #007AFF;
            /* iOS Blue */
            --bg: #F2F2F7;
            /* èƒŒæ™¯è‰² */
            --card: #FFFFFF;
            /* ã‚«ãƒ¼ãƒ‰ã®ç™½ */
            --text: #1C1C1E;
            /* æ–‡å­—è‰² */
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        h2 {
            margin-bottom: 10px;
        }

        .container {
            width: 100%;
            max-width: 400px;
            /* ã‚¹ãƒãƒ›ã§è¦‹ã‚„ã™ã„å¹…ã«åˆ¶é™ */
            display: flex;
            flex-direction: column;
            gap: 15px;
            /* è¦ç´ é–“ã®éš™é–“ */
        }

        /* ãƒ‘ãƒãƒ«(ã‚«ãƒ¼ãƒ‰)ã®ãƒ‡ã‚¶ã‚¤ãƒ³ */
        .card {
            background: var(--card);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            text-align: center;
        }

        /* æ¥ç¶šçŠ¶æ…‹ã‚’ç¤ºã™ç·‘ã®ä¸¸ãƒãƒ */
        .status-dot {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background-color: #ccc;
            /* æœªæ¥ç¶šã¯ã‚°ãƒ¬ãƒ¼ */
            margin-right: 5px;
        }

        /* æ¥ç¶šæ¸ˆã¿ã‚¯ãƒ©ã‚¹ (JavaScriptã§ä»˜ã‘å¤–ã—ã™ã‚‹) */
        .connected {
            background-color: #34C759;
            /* æ¥ç¶šæ™‚ã¯ç·‘ */
            box-shadow: 0 0 5px #34C759;
        }

        /* ãƒœã‚¿ãƒ³ã®å…±é€šã‚¹ã‚¿ã‚¤ãƒ« */
        button {
            background-color: var(--primary);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 20px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            width: 100%;
            transition: opacity 0.2s;
        }

        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

        button:active {
            opacity: 0.7;
        }

        /* ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠã‚¨ãƒªã‚¢ (ç‚¹ç·šæ ) */
        .file-upload {
            border: 2px dashed #ccc;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 10px;
            cursor: pointer;
        }

        /* å—ä¿¡ç”»åƒã®ã‚¹ã‚¿ã‚¤ãƒ« (ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ä»˜ã) */
        #imageArea img {
            max-width: 100%;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        /* ãƒ­ã‚°è¡¨ç¤ºã‚¨ãƒªã‚¢ */
        #logs {
            font-size: 10px;
            color: #666;
            height: 100px;
            overflow-y: scroll;
            text-align: left;
            border-top: 1px solid #eee;
            margin-top: 10px;
            padding-top: 10px;
        }

        @keyframes popIn {
            from {
                transform: scale(0.8);
                opacity: 0;
            }

            to {
                transform: scale(1);
                opacity: 1;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <h2>WebDrop</h2>

        <div class="card">
            <div style="margin-bottom: 10px; font-weight: bold;">
                <span id="statusDot" class="status-dot"></span>
                <span id="statusText">Disconnected</span>
            </div>
            <button id="connectBtn" onclick="startConnection()">Find partner (Connect)</button>
            <p style="font-size: 12px; color: #888;">Tap only one device</p>
        </div>

        <div class="card">
            <div class="file-upload" onclick="document.getElementById('fileInput').click()">
                ğŸ“ Tap to select an image
            </div>
            <input type="file" id="fileInput" style="display: none;" accept="image/*">
            <button id="sendBtn" onclick="sendFile()" disabled>Send image</button>
        </div>

        <div id="imageArea"></div>

        <div id="logs">Communication log...</div>
    </div>

    <script>
        // å¤‰æ•°ã®å®šç¾©
        const SIGNALING_URL = 'ws://localhost:8000/ws';                 // server.pyã§æŒ‡å®šã—ãŸURL
        const STUN_SERVER = { urls: 'stun:stun.l.google.com:19302' };   // Googleã®ç„¡æ–™STUNã‚µãƒ¼ãƒãƒ¼ (è‡ªåˆ†ã®ã‚°ãƒ­ãƒ¼ãƒãƒ«IPã‚’æ•™ãˆã¦ãã‚Œã‚‹)

        let socket;      // ã‚·ã‚°ãƒŠãƒªãƒ³ã‚°ã‚µãƒ¼ãƒãƒ¼ã¨ã®å›ç·š
        let peer;        // WebRTCã®æ¥ç¶šç®¡ç†ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ (ä»£ç†äºº)
        let dataChannel; // ãƒ‡ãƒ¼ã‚¿ã‚’é€ã‚‹ãŸã‚ã®åœŸç®¡ (P2Pãƒ‘ã‚¤ãƒ—)

        // ãƒ­ã‚°ã‚’è¡¨ç¤ºã™ã‚‹é–¢æ•°
        function log(text) {
            const el = document.getElementById('logs');         // ãƒ­ã‚°è¡¨ç¤ºã‚¨ãƒªã‚¢
            el.innerHTML = `<div>${text}</div>` + el.innerHTML; // æ–°ã—ã„ãƒ­ã‚°ã‚’ä¸Šã«è¿½è¨˜
        }

        // ç”»é¢ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤ºã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
        function updateStatus(connected) {
            const dot = document.getElementById('statusDot');
            const text = document.getElementById('statusText');
            const btn = document.getElementById('sendBtn');
            if (connected) {
                dot.classList.add('connected');
                text.innerText = "Connected";
                text.style.color = "#34C759";
                btn.disabled = false; // é€ä¿¡ãƒœã‚¿ãƒ³æœ‰åŠ¹åŒ–
                document.getElementById('connectBtn').style.display = 'none'; // æ¥ç¶šãƒœã‚¿ãƒ³ã¯ã‚‚ã†ä¸è¦ãªã®ã§æ¶ˆã™
            } else {
                dot.classList.remove('connected');
            }
        }

        // 1. ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«server.pyã¸æ¥ç¶š
        window.onload = () => {
            log(`Server URL: ${SIGNALING_URL}`);    // log()ã§ãƒ–ãƒ©ã‚¦ã‚¶ã®ãƒ­ã‚°è¡¨ç¤ºã‚¨ãƒªã‚¢ã«è¡¨ç¤º
            socket = new WebSocket(SIGNALING_URL);  // server.pyã¸WebSocketæ¥ç¶š

            socket.onopen = () => log("Server connection established");

            // ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒå±Šã„ãŸæ™‚ã®å‡¦ç†
            socket.onmessage = async (event) => {
                // WebRTCã®æº–å‚™ãŒã§ãã¦ã„ãªã„ãªã‚‰åˆæœŸåŒ–
                if (!peer) initializePeer();

                try {
                    const data = JSON.parse(event.data);

                    // A. ç›¸æ‰‹ã‹ã‚‰SDP(æš—å·åŒ–æ–¹å¼ãªã©)ãŒå±Šã„ãŸå ´åˆ
                    if (data.sdp) {
                        await peer.setRemoteDescription(new RTCSessionDescription(data.sdp));   // ç›¸æ‰‹ã®æƒ…å ±ã‚’ã‚»ãƒƒãƒˆ

                        // ã‚‚ã—ç›¸æ‰‹ã‹ã‚‰ã®ã€Œç”³ã—è¾¼ã¿(Offer)ã€ã ã£ãŸã‚‰ã€ã€Œæ‰¿è«¾(Answer)ã€ã‚’ä½œã£ã¦è¿”ã™
                        if (data.sdp.type === 'offer') {
                            const answer = await peer.createAnswer();
                            await peer.setLocalDescription(answer);
                            // ã‚µãƒ¼ãƒãƒ¼çµŒç”±ã§è¿”é€
                            socket.send(JSON.stringify({ sdp: answer }));
                            log("Answerã‚’é€ä¿¡");
                        }
                    }
                    // B. ç›¸æ‰‹ã‹ã‚‰ICE Candidate(é€šä¿¡çµŒè·¯ã®å€™è£œ)ãŒå±Šã„ãŸå ´åˆ
                    else if (data.candidate) {
                        await peer.addIceCandidate(new RTCIceCandidate(data.candidate));       // é€šä¿¡çµŒè·¯ã®å€™è£œã‚’è¿½åŠ 
                    }
                } catch (e) { console.error(e); }
            };
        };

        // --- 2. WebRTCã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ(peer)ã®æº–å‚™ ---
        function initializePeer() {
            // WebRTCæ¥ç¶šã‚’ä½œæˆ
            peer = new RTCPeerConnection({ iceServers: [STUN_SERVER] });

            // â˜…ã‚¤ãƒ™ãƒ³ãƒˆ: è‡ªåˆ†ã®ã€Œä½æ‰€å€™è£œã€ãŒè¦‹ã¤ã‹ã£ãŸã‚‰ã€ã‚µãƒ¼ãƒãƒ¼çµŒç”±ã§ç›¸æ‰‹ã«é€ã‚‹
            peer.onicecandidate = (e) => {
                if (e.candidate) socket.send(JSON.stringify({ candidate: e.candidate }));
            };

            // â˜…ã‚¤ãƒ™ãƒ³ãƒˆ: ç›¸æ‰‹ã‹ã‚‰ã€Œãƒ‡ãƒ¼ã‚¿ãƒãƒ£ãƒãƒ«(åœŸç®¡)ã€ãŒæ¥ç¶šã•ã‚ŒãŸã‚‰(å—ä¿¡å´)
            peer.ondatachannel = (e) => setupDataChannel(e.channel);
        }

        // --- 3. æ¥ç¶šé–‹å§‹ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ãŸæ™‚ã®å‡¦ç† (ç™ºä¿¡å´) ---
        async function startConnection() {
            initializePeer();

            // è‡ªåˆ†ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ãƒãƒ£ãƒãƒ«(åœŸç®¡)ã‚’ä½œã‚‹
            dataChannel = peer.createDataChannel("file-transfer");
            setupDataChannel(dataChannel); // è‡ªåˆ†ã®åœŸç®¡ã‚’è¨­å®š

            // Offer(æ¥ç¶šã®ç”³ã—è¾¼ã¿)ã‚’ä½œæˆ
            const offer = await peer.createOffer();
            await peer.setLocalDescription(offer);

            // ã‚µãƒ¼ãƒãƒ¼çµŒç”±ã§ç›¸æ‰‹ã«Offerã‚’é€ã‚‹
            socket.send(JSON.stringify({ sdp: offer }));
            log("Offer sent");
        }

        // --- 4. ãƒ‡ãƒ¼ã‚¿ãƒãƒ£ãƒãƒ«(åœŸç®¡)ã®è¨­å®š ---
        function setupDataChannel(channel) {
            dataChannel = channel;
            dataChannel.binaryType = 'arraybuffer'; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯ãƒã‚¤ãƒŠãƒªãƒ‡ãƒ¼ã‚¿ã‚’æ‰±ãˆãªã„ãŸã‚ã€ã“ã‚Œã‚’æŒ‡å®šã™ã‚‹

            // P2Pæ¥ç¶šå®Œäº†ï¼
            dataChannel.onopen = () => {
                log("P2P connection established");
                updateStatus(true);
            };

            // ãƒ‡ãƒ¼ã‚¿å—ä¿¡æ™‚ã®å‡¦ç†
            dataChannel.onmessage = (e) => {
                // ãƒã‚¤ãƒŠãƒªãƒ‡ãƒ¼ã‚¿ãªã‚‰ç”»åƒã¨ã—ã¦å‡¦ç†
                if (typeof e.data !== 'string') {
                    // ArrayBufferã‚’Blob(ãƒ•ã‚¡ã‚¤ãƒ«é¢¨ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ)ã«å¤‰æ›
                    const blob = new Blob([e.data]);
                    // ãƒ–ãƒ©ã‚¦ã‚¶ã§è¡¨ç¤ºã§ãã‚‹URLã‚’ç”Ÿæˆ
                    const url = URL.createObjectURL(blob);

                    // imgã‚¿ã‚°ã‚’ä½œã£ã¦è¡¨ç¤º
                    const img = document.createElement('img');
                    img.src = url;

                    // å¤ã„ç”»åƒã‚’æ¶ˆã—ã¦æ–°ã—ã„ç”»åƒã‚’è¡¨ç¤º
                    const area = document.getElementById('imageArea');
                    area.innerHTML = '';
                    area.appendChild(img);
                    log(`Image received (${e.data.byteLength} bytes)`);
                }
            };
        }

        // --- 5. ãƒ•ã‚¡ã‚¤ãƒ«é€ä¿¡å‡¦ç† ---
        function sendFile() {
            const file = document.getElementById('fileInput').files[0];
            if (!file) return alert("Select an image");

            // ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚€ãƒªãƒ¼ãƒ€ãƒ¼ã‚’ä½œæˆ
            const reader = new FileReader();

            // èª­ã¿è¾¼ã¿å®Œäº†å¾Œã«å®Ÿè¡Œã•ã‚Œã‚‹å‡¦ç†
            reader.onload = (e) => {
                // e.target.result ã«ã¯ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒã‚¤ãƒŠãƒªãƒ‡ãƒ¼ã‚¿(ArrayBuffer)ãŒå…¥ã£ã¦ã„ã‚‹
                dataChannel.send(e.target.result); // P2Pã§ç›´æ¥é€ä¿¡ï¼
                log("Image sent");
            };

            // ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ArrayBufferã¨ã—ã¦èª­ã¿è¾¼ã‚€
            reader.readAsArrayBuffer(file);
        }

        // ãŠã¾ã‘: ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠæ™‚ã«ãƒ•ã‚¡ã‚¤ãƒ«åã‚’ãƒ­ã‚°ã«å‡ºã™
        document.getElementById('fileInput').addEventListener('change', function () {
            if (this.files[0]) log(`Selected: ${this.files[0].name}`);
        });
    </script>
</body>

</html>